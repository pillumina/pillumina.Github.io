<!doctype html><html lang=en dir=auto><head><meta name=generator content="Hugo 0.148.2"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CctoctoFX</title><meta name=description content><meta name=author content="Me"><link rel=canonical href=https://pillumina.github.io/><link crossorigin=anonymous href=/assets/css/stylesheet.9d388901283682bb45dd422fcaa0d0a2054a3c8ff47c9cc6b2baab15508b1b90.css integrity="sha256-nTiJASg2grtF3UIvyqDQogVKPI/0fJzGsrqrFVCLG5A=" rel="preload stylesheet" as=style><link rel=icon href=https://pillumina.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://pillumina.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://pillumina.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://pillumina.github.io/apple-touch-icon.png><link rel=mask-icon href=https://pillumina.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://pillumina.github.io/index.xml><link rel=alternate type=application/json href=https://pillumina.github.io/index.json><link rel=alternate hreflang=en href=https://pillumina.github.io/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js crossorigin=anonymous></script><script>(function(){function t(){return document.querySelector(".post-content")||document.querySelector(".post-single")||document.body}function n(e){return/\$\$[\s\S]+?\$\$|\\\(|\\\)|\\\[|\\\]/.test(e)}function s(e){if(window.__mathjaxLoaded)return;window.__mathjaxLoaded=!0,window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre","code","tt"],ignoreHtmlClass:"no-math"}};var t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js",t.defer=!0,t.onload=function(){window.MathJax&&window.MathJax.typesetPromise&&window.MathJax.typesetPromise([e]).catch(function(e){console.warn("MathJax typeset error",e)})},document.head.appendChild(t)}function e(){try{if(typeof renderMathInElement=="function"){const e=t();renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1}],throwOnError:!1,strict:!1,trust:!0,ignoredTags:["script","noscript","style","textarea","pre","code","tt"],ignoredClasses:["no-math"],macros:{"\\boldsymbol":"\\mathbf{#1}","\\bm":"\\mathbf{#1}"}}),setTimeout(function(){n(e.innerHTML)&&s(e)},200)}}catch(e){console.warn("KaTeX render error:",e)}}document.addEventListener("DOMContentLoaded",function(){e(),setTimeout(e,200)}),window.addEventListener("load",function(){setTimeout(e,0)})})()</script><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script>const config={startOnLoad:!0,theme:"neutral",themeVariables:{lineColor:"#0f0f0f"},flowchart:{useMaxWidth:!1,htmlLabels:!0}};mermaid.initialize(config),window.onload=()=>{window.mermaid.init(0[0],document.querySelectorAll(".language-mermaid"))}</script><link rel=stylesheet href=/css/custom.min.bda7229c4269a242639e058fb11a4782f02f8d77071ba16609befee67cc41c49.css integrity="sha256-vacinEJpokJjngWPsRpHgvAvjXcHG6FmCb7+5nzEHEk="><script>document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll("h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]"),n=document.querySelectorAll(".toc a");if(t.length===0||n.length===0)return;const s={};t.forEach(e=>{s[e.id]=e.offsetTop});function i(){const t=window.scrollY+100;let e="";for(const[n,o]of Object.entries(s))if(t>=o)e=n;else break;return e}function o(){const e=i();if(n.forEach(e=>{e.classList.remove("active")}),e){const t=document.querySelector(`.toc a[href="#${e}"]`);t&&t.classList.add("active")}}let e=!1;window.addEventListener("scroll",function(){e||(window.requestAnimationFrame(function(){o(),e=!1}),e=!0)}),o()})</script><meta property="og:url" content="https://pillumina.github.io/"><meta property="og:site_name" content="CctoctoFX"><meta property="og:title" content="CctoctoFX"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://pillumina.github.io/imgs/icon_head.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pillumina.github.io/imgs/icon_head.png"><meta name=twitter:title content="CctoctoFX"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"CctoctoFX","url":"https://pillumina.github.io/","description":"","logo":"https://pillumina.github.io/favicon.ico","sameAs":["derios1230@gmail.com","https://github.com/pillumina","https://gitee.com/pillumina"]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://pillumina.github.io/ accesskey=h title="CctoctoFX (Alt + H)"><img src=https://pillumina.github.io/apple-touch-icon.png alt aria-label=logo height=30>CctoctoFX</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://pillumina.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://pillumina.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://pillumina.github.io/posts/aiinfra/ title="AI Infra"><span>AI Infra</span></a></li><li><a href=https://pillumina.github.io/posts/llmtheory/ title=Thoery><span>Thoery</span></a></li><li><a href=https://pillumina.github.io/posts/programming/ title=Programming><span>Programming</span></a></li><li><a href=https://pillumina.github.io/social/ title=Social><span>Social</span></a></li><li><a href=https://pillumina.github.io/open_courses/ title=Study><span>Study</span></a></li></ul></nav></header><main class=main><article class="first-entry home-info"><header class=entry-header><h1>CctoctoFX (Yuxiao Huang)</h1></header><div class=entry-content><div class=row><div class=profile-text><p>Hey there! Iâ€™m a software engineer obsessed with untangling complex systems.<br>My playground includes:</p><ul><li><p>âš™ï¸ Software architecture (scaling the unscalable),</p></li><li><p>ğŸ§  LLM training/inference (squeezing speed from silicon),</p></li><li><p>ğŸ“ˆ Economic systems & ğŸŒ geopolitics (decoding money & power).</p></li><li><p>AI Infrastructure (AI Infra) & ML Systems (MLSys) are my battlefield: deep dives on scaling, optimization, and the guts of large models. Beyond the keyboard, I also share spicy takes on geopolitics when the mood strikes.</p></li><li><p>No fluff, just signal. Join the conversation!</p></li></ul></div><div class=profile-img><img draggable=false src=https://pillumina.github.io/imgs/icon_head.png alt=profile title=profile height=150 width=150></div></div></div></div></div><footer class=entry-footer><div class=social-icons><a href=derios1230@gmail.com target=_blank rel="noopener noreferrer me" title=Email><svg viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
</a><a href=https://github.com/pillumina target=_blank rel="noopener noreferrer me" title=Github><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=https://gitee.com/pillumina target=_blank rel="noopener noreferrer me" title=Gitea><svg viewBox="0 0 24 20" fill="currentColor"><path d="M4.209 4.603c-.247.0-.525.02-.84.088-.333.07-1.28.283-2.054 1.027C-.403 7.25.035 9.685.089 10.052c.065.446.263 1.687 1.21 2.768 1.749 2.141 5.513 2.092 5.513 2.092s.462 1.103 1.168 2.119c.955 1.263 1.936 2.248 2.89 2.367 2.406.0 7.212-.004 7.212-.004s.458.004 1.08-.394c.535-.324 1.013-.893 1.013-.893s.492-.527 1.18-1.73c.21-.37.385-.729.538-1.068.0.0 2.107-4.471 2.107-8.823-.042-1.318-.367-1.55-.443-1.627-.156-.156-.366-.153-.366-.153s-4.475.252-6.792.306c-.508.011-1.012.023-1.512.027v4.474l-.634-.301c0-1.39-.004-4.17-.004-4.17-1.107.016-3.405-.084-3.405-.084s-5.399-.27-5.987-.324c-.187-.011-.401-.032-.648-.032zm.354 1.832h.111s.271 2.269.6 3.597C5.549 11.147 6.22 13 6.22 13s-.996-.119-1.641-.348c-.99-.324-1.409-.714-1.409-.714s-.73-.511-1.096-1.52C1.444 8.73 2.021 7.7 2.021 7.7s.32-.859 1.47-1.145c.395-.106.863-.12 1.072-.12zm8.33 2.554c.26.003.509.127.509.127l.868.422-.529 1.075a.686.686.0 00-.614.359.685.685.0 00.072.756l-.939 1.924a.69.69.0 00-.66.527.687.687.0 00.347.763.686.686.0 00.867-.206.688.688.0 00-.069-.882l.916-1.874a.667.667.0 00.237-.02.657.657.0 00.271-.137 8.826 8.826.0 011.016.512.761.761.0 01.286.282c.073.21-.073.569-.073.569-.087.29-.702 1.55-.702 1.55a.692.692.0 00-.676.477.681.681.0 101.157-.252c.073-.141.141-.282.214-.431.19-.397.515-1.16.515-1.16.035-.066.218-.394.103-.814-.095-.435-.48-.638-.48-.638-.467-.301-1.116-.58-1.116-.58s0-.156-.042-.27a.688.688.0 00-.148-.241l.516-1.062 2.89 1.401s.48.218.583.619c.073.282-.019.534-.069.657-.24.587-2.1 4.317-2.1 4.317s-.232.554-.748.588a1.065 1.065.0 01-.393-.045l-.202-.08-4.31-2.1s-.417-.218-.49-.596c-.083-.31.104-.691.104-.691l2.073-4.272s.183-.37.466-.497a.855.855.0 01.35-.077z"/></svg></a></div></footer></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>[Deterministic RL] deterministicé—®é¢˜çš„æ¥æºå’Œç›¸å…³å·¥ä½œæ€»ç»“</h2></header><div class=entry-content><p>ç†è§£LLMæ¨ç†ä¸­deterministicé—®é¢˜æ¥æº Wikiä¸Šå¯¹deterministicç®—æ³•çš„å®šä¹‰æ˜¯:
â€œa deterministic algorithm is an algorithm that, given a particular input, will always produce the same output.â€
è€Œæˆ‘ä»¬åœ¨æ–‡ä¸­è¦è®¨è®ºçš„ï¼Œå³å¯¹äºLLMè¿™ä¸ªcontextä¸‹çš„deterministicé—®é¢˜ï¼Œæˆ‘ä¼šå…ˆä»inferenceè§’åº¦ï¼ˆå³é‡å¤ç»™å®šä¸€ä¸ªç¡®å®šçš„inputï¼Œæ¨¡å‹çš„æ¨ç†ä¸ºä»€ä¹ˆæ— æ³•ç»™å®šç¡®å®šçš„è¾“å‡ºï¼‰è¿›è¡Œé—®é¢˜çš„ç†è§£ï¼Œå†è¿›ä¸€æ­¥è®¨è®ºRLå·¥ç¨‹ä¸­çš„training & inferenceä¹‹é—´å·®å¼‚ï¼Œå¯èƒ½ä¼šå¯¼è‡´RLè®­ç»ƒçš„å´©æºƒé—®é¢˜ï¼Œå¹¶ç»§ç»­è®¨è®ºä¸šç•Œç°åœ¨å·²æœ‰çš„è§£å†³æ–¹æ¡ˆã€ä¸è¿˜åœ¨working-in-progressçš„å·¥ä½œã€‚
æµ®ç‚¹æ•°çš„éç»“åˆæ€§ thinking machines labé’ˆå¯¹batch invariantè®¨è®ºçš„æ–‡ç« ï¼Œè¯¦ç»†åœ°è§£é‡Šäº†åœ¨LLMæ¨ç†ä¸­ä¸ç¡®å®šæ€§çš„æ¥åŸï¼Œå³å› ä¸ºç²¾åº¦æœ‰é™ï¼ŒGPUæµ®ç‚¹æ•°è¿ç®—ä¸­çš„ç»“åˆæ€§é€šå¸¸ä¸æˆç«‹ï¼š
$$(a+b)+c \neq a+(b+c) $$
è¿™ç¯‡arxivæ–‡ç« ï¼Œåˆ™æ›´æ·±å…¥å¾—è¯´æ˜äº†è¿™ä¸ªé—®é¢˜ï¼š
Floating-point arithmetic in GPUs exhibits non-associativity, meaningÂ (a+b)+câ‰ a+(b+c)(a+b)+cî€ =a+(b+c)Â due to finite precision and rounding errors. This property directly impacts the computation of attention scores and logits in the transformer architecture, where parallel operations across multiple threads can yield different results based on execution order.
...</p></div><footer class=entry-footer><span title='2025-11-20 11:30:12 +0800 CST'>November 20, 2025</span>&nbsp;Â·&nbsp;4 min&nbsp;Â·&nbsp;816 words&nbsp;Â·&nbsp;Me</footer><a class=entry-link aria-label="post link to [Deterministic RL] deterministicé—®é¢˜çš„æ¥æºå’Œç›¸å…³å·¥ä½œæ€»ç»“" href=https://pillumina.github.io/posts/aiinfra/14-deterministic-rl/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>[vLLM-Ascend] MC2æŠ€æœ¯æ·±åº¦è§£æï¼šä»MoEæ¶æ„åˆ°é€šä¿¡èåˆä¼˜åŒ–</h2></header><div class=entry-content><p>æºç åˆ†æä¾èµ–vllm-ascendåœ¨2025/9/20å·çš„mainåˆ†æ”¯ï¼Œé˜…è¯»è¯·æ³¨æ„æ—¶æ•ˆæ€§ã€‚
é˜…è¯»å»ºè®®:
äº†è§£MoEåŸºæœ¬æ¶æ„å’Œå…³é”®æ¨å¯¼ åˆæ­¥äº†è§£é›†åˆé€šä¿¡å„åŸè¯­çš„å«ä¹‰ å¯¹é€šç®—æ©ç›–è¿™ç±»æ€§èƒ½ä¼˜åŒ–æœ‰åŸºç¡€çš„äº†è§£ æ¦‚è¿° MC2ï¼ˆMerged Compute and Communicationï¼‰æ˜¯vLLM Ascendé¡¹ç›®ä¸­é’ˆå¯¹æ˜‡è…¾NPUä¼˜åŒ–çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä¸“é—¨è§£å†³MoEï¼ˆMixture of Expertsï¼‰æ¨¡å‹åœ¨ä¸“å®¶å¹¶è¡Œæ¨ç†ä¸­çš„é€šä¿¡ç“¶é¢ˆé—®é¢˜ã€‚æœ¬æ–‡æ¡£ä»MoEæ¶æ„åŸºç¡€å‡ºå‘ï¼Œæ·±å…¥åˆ†æMC2çš„è®¾è®¡åŸç†ã€æŠ€æœ¯å®ç°å’Œæ€§èƒ½ä¼˜åŒ–ã€‚
1. MoEæ¶æ„åŸºç¡€ä¸æŒ‘æˆ˜ 1.1 MoEæ¨¡å‹åŸºæœ¬åŸç† 1.1.1 ä»€ä¹ˆæ˜¯MoEï¼Ÿ **MoE(Mixture of Experts)**æ˜¯ä¸€ç§ç¥ç»ç½‘ç»œæ¶æ„ï¼Œé€šè¿‡å°†æ¨¡å‹å‚æ•°åˆ†æ•£åˆ°å¤šä¸ª"ä¸“å®¶"ç½‘ç»œä¸­ï¼Œæ ¹æ®è¾“å…¥åŠ¨æ€é€‰æ‹©éƒ¨åˆ†ä¸“å®¶è¿›è¡Œè®¡ç®—ã€‚è¿™ç§æ¶æ„åœ¨ä¿æŒé«˜æ¨¡å‹å®¹é‡çš„åŒæ—¶ï¼Œé™ä½äº†è®¡ç®—å¤æ‚åº¦ã€‚
1.1.2 MoEçš„æ•°å­¦è¡¨è¾¾ ç»™å®šè¾“å…¥ $\mathbf{x} \in \mathbb{R}^{d}$ï¼ŒMoEå±‚çš„è¾“å‡ºå¯ä»¥è¡¨ç¤ºä¸ºï¼š
$$ \mathbf{y} = \text{MoE}(\mathbf{x}) = \sum_{i=1}^{N} g_i(\mathbf{x}) \cdot E_i(\mathbf{x}) $$å…¶ä¸­ï¼š
$N$ æ˜¯ä¸“å®¶æ€»æ•° $E_i(\cdot)$ æ˜¯ç¬¬ $i$ ä¸ªä¸“å®¶ç½‘ç»œ $g_i(\mathbf{x})$ æ˜¯é—¨æ§ç½‘ç»œå¯¹ä¸“å®¶ $i$ çš„æƒé‡ 1.1.3 ç¨€ç–æ¿€æ´»æœºåˆ¶ ä¸ºäº†æé«˜æ•ˆç‡ï¼ŒMoEé€šå¸¸é‡‡ç”¨ç¨€ç–æ¿€æ´»æœºåˆ¶ï¼Œåªé€‰æ‹© Top-K ä¸ªä¸“å®¶ï¼š
$$ \mathbf{y} = \sum_{i \in \text{Top-K}(\mathbf{x})} \frac{g_i(\mathbf{x})}{\sum_{j \in \text{Top-K}(\mathbf{x})} g_j(\mathbf{x})} \cdot E_i(\mathbf{x}) $$è¯¦è§é™„å½•A.1 MoEè¾“å‡ºå…¬å¼æ¨å¯¼
å…¶ä¸­ $\text{Top-K}(\mathbf{x})$ è¡¨ç¤ºæ ¹æ®é—¨æ§æƒé‡é€‰æ‹©çš„ Top-K ä¸ªä¸“å®¶ç´¢å¼•ã€‚
...</p></div><footer class=entry-footer><span title='2025-09-20 11:30:12 +0800 CST'>September 20, 2025</span>&nbsp;Â·&nbsp;20 min&nbsp;Â·&nbsp;4189 words&nbsp;Â·&nbsp;Me</footer><a class=entry-link aria-label="post link to [vLLM-Ascend] MC2æŠ€æœ¯æ·±åº¦è§£æï¼šä»MoEæ¶æ„åˆ°é€šä¿¡èåˆä¼˜åŒ–" href=https://pillumina.github.io/posts/aiinfra/13-vllmascend-mc2/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>[VeRL,SGLang] RLè®­æ¨æ˜¾å­˜ç®¡ç†ä¼˜åŒ–</h2></header><div class=entry-content><p>SGLangå›¢é˜Ÿçš„åšå®¢ï¼šhttps://hebiao064.github.io/rl-memory-management
Overview ä¸Šè¿°æ˜¯ç®€åŒ–çš„åœ¨çº¿RLè®­ç»ƒæµç¨‹ï¼Œéšå»äº†referenceå’Œcritic modelï¼Œå¹¶ä¸”ç”¨åŸºç¡€çš„reward functionè€Œéreward modelæ¥è¯´æ˜æµç¨‹ã€‚å®é™…ä¸Šå°±æ˜¯policy modelå­˜åœ¨çš„training engineå’Œrollout engineä¸Šéœ€è¦è¿›è¡Œä¼˜åŒ–ã€‚
ä»ç®€åŒ–çš„PPOæµç¨‹å¼€å§‹ï¼š
1 2 3 4 5 6 7 8 9 for prompts, pretrain_batch in dataloader: # Stage 1: Rollout generation (inference) batch = actor.generate_sequences(prompts) # Stage 2: Prepare experience batch = reference.compute_log_prob(batch) batch = reward.compute_reward(batch) # Reward function or model batch = compute_advantages(batch, algo_type) # Stage 3: Actor training actor_metrics = actor.update_actor(batch) æ¯ä¸€ä¸ªiterç›¸å½“äºæ˜¯actor modelè¿›è¡Œä¸€æ¬¡rolloutå†è¿›è¡Œtrainingï¼Œè€ŒveRLå› ä¸ºrolloutå’Œtrainingå…±éƒ¨ç½²ï¼Œæ‰€ä»¥ä¸¤è¾¹å¯èƒ½ä¸ç”¨versionçš„actor modelæ˜¯åœ¨ç›¸åŒçš„GPUç»„ä¸Šçš„ï¼Œè¿™å¯¼è‡´äº†è™½ç„¶èµ„æºå…±äº«ä½†æ˜¯æ˜¾å­˜ç®¡ç†ä¼šå˜å¾—æ›´å¤æ‚ã€‚
æ˜¾å­˜é—®é¢˜ è®­ç»ƒé˜¶æ®µæ˜¾å­˜ FSDPï¼ˆfully sharded + full activation checkpointingï¼‰ä¸‹ï¼Œæ¯ä¸ªGPUå æ®æ˜¾å­˜ï¼š
æ¯ä¸ªGPUçš„å³°å€¼æ˜¾å­˜ï¼š~48GB
æ¨ç†é˜¶æ®µæ˜¾å­˜ During inference, the full model is typically loaded (not sharded):
...</p></div><footer class=entry-footer><span title='2025-09-17 11:30:12 +0800 CST'>September 17, 2025</span>&nbsp;Â·&nbsp;2 min&nbsp;Â·&nbsp;404 words&nbsp;Â·&nbsp;Me</footer><a class=entry-link aria-label="post link to [VeRL,SGLang] RLè®­æ¨æ˜¾å­˜ç®¡ç†ä¼˜åŒ–" href=https://pillumina.github.io/posts/aiinfra/12-verl-sglang-memory/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>[AIInfra] FlashAttention æ·±åº¦è§£æï¼šä»æ•°å­¦åŸç†åˆ°å·¥ç¨‹å®ç°</h2></header><div class=entry-content><p>æœ¬æ–‡ä»æ•°å­¦åŸç†å‡ºå‘ï¼Œæ·±å…¥åˆ†æFlashAttentionçš„æ ¸å¿ƒæ€æƒ³ã€ç®—æ³•è®¾è®¡å’Œå„ç‰ˆæœ¬æ¼”è¿›ï¼Œé€šè¿‡è¯¦å®çš„æ•°å­¦æ¨å¯¼ã€ç›´è§‚çš„æµç¨‹å›¾è¡¨å’Œå…·ä½“çš„æ•°å€¼ç¤ºä¾‹ï¼Œå¸®åŠ©è¯»è€…çœŸæ­£æŒæ¡è¿™ä¸€é©å‘½æ€§çš„Attentionä¼˜åŒ–æŠ€æœ¯ã€‚
1. é—®é¢˜çš„æœ¬è´¨ï¼šä¼ ç»ŸAttentionçš„æ ¹æœ¬ç“¶é¢ˆ 1.1 ä¼ ç»ŸAttentionæœºåˆ¶çš„è®¡ç®—æ¨¡å¼ ä¼ ç»Ÿçš„Self-Attentionæœºåˆ¶éµå¾ªå¦‚ä¸‹è®¡ç®—æµç¨‹ï¼š
$$ \text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V $$è®©æˆ‘ä»¬ç”¨å…·ä½“æ•°å€¼æ¥ç†è§£è¿™ä¸ªè¿‡ç¨‹çš„å¤æ‚æ€§ï¼š
ç¤ºä¾‹åœºæ™¯ï¼šè€ƒè™‘ä¸€ä¸ªå…¸å‹çš„è¯­è¨€æ¨¡å‹åœºæ™¯
åºåˆ—é•¿åº¦ï¼š$n = 2048$ï¼ˆå¦‚GPT-2çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼‰ ç‰¹å¾ç»´åº¦ï¼š$d_k = 64$ï¼ˆæ¯ä¸ªattention headçš„ç»´åº¦ï¼‰ è¾“å…¥å¼ é‡å½¢çŠ¶ï¼š$Q, K, V \in \mathbb{R}^{2048 \times 64}$ ç¬¬ä¸€æ­¥ï¼šè®¡ç®—æ³¨æ„åŠ›å¾—åˆ†çŸ©é˜µ $$S = \frac{QK^T}{\sqrt{d_k}} \in \mathbb{R}^{2048 \times 2048}$$è¿™ä¸€æ­¥äº§ç”Ÿäº†ä¸€ä¸ª $2048 \times 2048 = 4,194,304$ ä¸ªå…ƒç´ çš„çŸ©é˜µï¼Œä»¥FP16ç²¾åº¦å­˜å‚¨éœ€è¦çº¦8MBå†…å­˜ã€‚
ç¬¬äºŒæ­¥ï¼šSoftmaxå½’ä¸€åŒ– $$P = \text{softmax}(S) \in \mathbb{R}^{2048 \times 2048}$$Softmaxè®¡ç®—éœ€è¦ï¼š
è®¡ç®—æ¯è¡Œçš„æœ€å¤§å€¼ï¼š$m_i = \max_j S_{i,j}$ è®¡ç®—æŒ‡æ•°å’Œï¼š$l_i = \sum_j e^{S_{i,j} - m_i}$ å½’ä¸€åŒ–ï¼š$P_{i,j} = \frac{e^{S_{i,j} - m_i}}{l_i}$ è¿™åˆéœ€è¦å­˜å‚¨å¦ä¸€ä¸ª $2048 \times 2048$ çš„çŸ©é˜µã€‚
...</p></div><footer class=entry-footer><span title='2025-09-15 11:30:12 +0800 CST'>September 15, 2025</span>&nbsp;Â·&nbsp;11 min&nbsp;Â·&nbsp;2204 words&nbsp;Â·&nbsp;Me</footer><a class=entry-link aria-label="post link to [AIInfra] FlashAttention æ·±åº¦è§£æï¼šä»æ•°å­¦åŸç†åˆ°å·¥ç¨‹å®ç°" href=https://pillumina.github.io/posts/aiinfra/11-flashattention/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>[VeRL] DataProtoä»‹ç»</h2></header><div class=entry-content><p>Verl DataProto å®ç°åŸç†ä¸æ•°æ®æµåŠ¨åˆ†æ ç›®å½• 1. æ¦‚è¿° 2. DataProto æ ¸å¿ƒæ¶æ„ 3. HybridFlow è®¾è®¡ç†å¿µ 4. æ§åˆ¶æµä¸è®¡ç®—æµåˆ†ç¦» 5. æ•°æ®æµåŠ¨æœºåˆ¶ 6. Dispatch æ¨¡å¼è¯¦è§£ 7. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ 8. æ€»ç»“ 1. æ¦‚è¿° Verl æ˜¯ä¸€ä¸ªåŸºäº HybridFlow è®ºæ–‡çš„å¼€æºå¼ºåŒ–å­¦ä¹ è®­ç»ƒæ¡†æ¶ï¼Œä¸“é—¨ä¸ºå¤§è¯­è¨€æ¨¡å‹çš„åè®­ç»ƒä¼˜åŒ–è€Œè®¾è®¡ã€‚å…¶æ ¸å¿ƒåˆ›æ–°åœ¨äºå°†æ§åˆ¶æµå’Œè®¡ç®—æµåˆ†ç¦»ï¼Œé€šè¿‡ DataProto åè®®å®ç°é«˜æ•ˆçš„æ•°æ®äº¤æ¢ã€‚
2. DataProto æ ¸å¿ƒæ¶æ„ 2.1 æ•°æ®ç»“æ„è®¾è®¡ DataProto æ˜¯ verl æ¡†æ¶ä¸­ç”¨äºæ•°æ®äº¤æ¢çš„æ ¸å¿ƒåè®®ï¼Œæ‰€æœ‰åœ¨ Worker ä¹‹é—´æµè½¬çš„æ•°æ®ï¼Œéƒ½è¢«ç»Ÿä¸€å°è£…åœ¨ä¸€ä¸ªåä¸º DataProto çš„æ•°æ®ç»“æ„ä¸­ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæ›´æ‰¿è½½ç€ RLHF æµç¨‹ä¸­æ‰€æœ‰çš„ä¿¡æ¯æ¼”å˜, åŸºäº PyTorch çš„ TensorDict æ„å»ºï¼š
1 2 3 4 5 @dataclass class DataProto: batch: TensorDict = None # å¼ é‡æ•°æ®å®¹å™¨ non_tensor_batch: dict = field(default_factory=dict) # éå¼ é‡æ•°æ® meta_info: dict = field(default_factory=dict) # å…ƒä¿¡æ¯ æ ¸å¿ƒç‰¹æ€§ï¼š
ç»Ÿä¸€æ¥å£: æä¾›æ ‡å‡†åŒ–çš„æ•°æ®å®¹å™¨ï¼Œæ”¯æŒå¼ é‡å’Œéå¼ é‡æ•°æ® è®¾å¤‡ç®¡ç†: è‡ªåŠ¨å¤„ç† GPU/CPU è®¾å¤‡é—´çš„æ•°æ®ç§»åŠ¨ å†…å­˜ä¼˜åŒ–: æ”¯æŒåˆ†å—å¤„ç†å’Œå†…å­˜å¤ç”¨ åºåˆ—åŒ–: æ”¯æŒé«˜æ•ˆçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ– 2.2 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 def check_consistency(self): """æ£€æŸ¥ DataProto çš„ä¸€è‡´æ€§""" if self.batch is not None: assert len(self.batch.batch_size) == 1, "åªæ”¯æŒ num_batch_dims=1" if self.non_tensor_batch is not None: for key, val in self.non_tensor_batch.items(): assert isinstance(val, np.ndarray) # æ£€æŸ¥æ‰¹æ¬¡å¤§å°ä¸€è‡´æ€§ if self.batch is not None and self.non_tensor_batch is not None: batch_size = self.batch.batch_size[0] for key, val in self.non_tensor_batch.items(): assert val.shape[0] == batch_size 3. HybridFlow è®¾è®¡ç†å¿µ 3.1 è®¾è®¡åŠ¨æœº ä¼ ç»Ÿ RL ç³»ç»Ÿé¢ä¸´çš„é—®é¢˜ï¼š
...</p></div><footer class=entry-footer><span title='2025-08-25 11:30:12 +0800 CST'>August 25, 2025</span>&nbsp;Â·&nbsp;17 min&nbsp;Â·&nbsp;3513 words&nbsp;Â·&nbsp;Me</footer><a class=entry-link aria-label="post link to [VeRL] DataProtoä»‹ç»" href=https://pillumina.github.io/posts/aiinfra/10-verl-dataproto/></a></article><footer class=page-footer><nav class=pagination><a class=next href=https://pillumina.github.io/page/2/>Next&nbsp;2/10&nbsp;Â»</a></nav></footer></main><footer class=footer><span>&copy; 2025 <a href=https://pillumina.github.io/>CctoctoFX</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg></a><div class=reading-progress-bar></div><script src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){const t=document.querySelector(".reading-progress-bar");if(!t)return;const n=document.querySelector(".post-single");if(!n)return;function s(){const e=n.getBoundingClientRect(),s=e.height,o=window.innerHeight,i=window.scrollY||window.pageYOffset,a=i/(s-o)*100;t.style.width=`${Math.min(100,Math.max(0,a))}%`}let e=!1;window.addEventListener("scroll",function(){e||(window.requestAnimationFrame(function(){s(),e=!1}),e=!0)}),s()}),document.addEventListener("DOMContentLoaded",function(){mediumZoom("article img:not(.nozoom)",{margin:24,background:"var(--theme)",scrollOffset:0})})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>