{{ if or .Params.math .Site.Params.math }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

<script>
(function() {
  function getArticleRoot() {
    return document.querySelector('.post-content') || document.querySelector('.post-single') || document.body;
  }
  function hasUnrenderedMath(html) {
    // 粗略检测仍存在的数学定界符（已排除 code/pre 由 ignoredTags 控制）
    return /\$\$[\s\S]+?\$\$|\\\(|\\\)|\\\[|\\\]/.test(html);
  }
  function loadMathJaxOnce(root) {
    if (window.__mathjaxLoaded) return;
    window.__mathjaxLoaded = true;
    window.MathJax = {
      tex: {
        inlineMath: [["$","$"],["\\(","\\)"]],
        displayMath: [["$$","$$"],["\\[","\\]"]],
        processEscapes: true
      },
      options: {
        skipHtmlTags: ["script","noscript","style","textarea","pre","code","tt"],
        ignoreHtmlClass: 'no-math'
      }
    };
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
    s.defer = true;
    s.onload = function() {
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([root]).catch(function(e){console.warn('MathJax typeset error', e)});
      }
    };
    document.head.appendChild(s);
  }
  function renderAll() {
    try {
      if (typeof renderMathInElement === 'function') {
        const root = getArticleRoot();
        renderMathInElement(root, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\[", right: "\\]", display: true},
            {left: "\\(", right: "\\)", display: false}
          ],
          throwOnError: false,
          strict: false,
          trust: true,
          ignoredTags: ["script","noscript","style","textarea","pre","code","tt"],
          ignoredClasses: ["no-math"],
          macros: {
            "\\boldsymbol": "\\mathbf{#1}",
            "\\bm": "\\mathbf{#1}"
          }
        });
        // 若仍检测到未渲染的数学表达式，则回退到 MathJax
        setTimeout(function(){
          if (hasUnrenderedMath(root.innerHTML)) {
            loadMathJaxOnce(root);
          }
        }, 200);
      }
    } catch (e) {
      console.warn("KaTeX render error:", e);
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    renderAll();
    setTimeout(renderAll, 200);
  });
  window.addEventListener('load', function() {
    setTimeout(renderAll, 0);
  });
})();
</script>
{{ end }}


<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
const config = {
    startOnLoad:true,
    theme: 'neutral',
    themeVariables: {
        lineColor: "#0f0f0f"  
    },
    flowchart: {
        useMaxWidth:false,
        htmlLabels:true
        }
};
mermaid.initialize(config);
window.onload = () => {
    window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid'));
}
</script>

<!-- 自定义样式 -->
{{ $custom := resources.Get "css/custom.css" }}
{{ $custom_style := $custom | resources.Minify | resources.Fingerprint }}
<link rel="stylesheet" href="{{ $custom_style.RelPermalink }}" integrity="{{ $custom_style.Data.Integrity }}">

<!-- TOC阅读进度跟踪 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 获取所有标题元素
    const headers = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
    // 获取所有TOC链接
    const tocLinks = document.querySelectorAll('.toc a');
    
    if (headers.length === 0 || tocLinks.length === 0) return;

    // 创建标题位置映射
    const headerPositions = {};
    headers.forEach(header => {
        headerPositions[header.id] = header.offsetTop;
    });

    // 获取当前激活的标题
    function getActiveHeader() {
        const scrollPosition = window.scrollY + 100; // 添加偏移量以提前触发
        
        let activeId = '';
        for (const [id, position] of Object.entries(headerPositions)) {
            if (scrollPosition >= position) {
                activeId = id;
            } else {
                break;
            }
        }
        return activeId;
    }

    // 更新TOC高亮
    function updateTocHighlight() {
        const activeId = getActiveHeader();
        
        // 移除所有active类
        tocLinks.forEach(link => {
            link.classList.remove('active');
        });
        
        // 添加active类到当前标题的链接
        if (activeId) {
            const activeLink = document.querySelector(`.toc a[href="#${activeId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }
    }

    // 监听滚动事件
    let ticking = false;
    window.addEventListener('scroll', function() {
        if (!ticking) {
            window.requestAnimationFrame(function() {
                updateTocHighlight();
                ticking = false;
            });
            ticking = true;
        }
    });

    // 初始化高亮
    updateTocHighlight();
});
</script>