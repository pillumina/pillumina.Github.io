---
title: "Kubernetes ConfigMap çƒ­æ›´æ–°"
date: 2021-04-24T11:22:18+08:00
hero: /images/posts/k8s-docker.jpg
menu:
  sidebar:
    name: Kubernetes ConfigMap Hot Update
    identifier: k8s-configmap-update
    parent: cloud-computing
    weight: 10
draft: false
---

  *æ³¨ï¼šå¦‚æœå¯¹kubernetesçš„åŸºæœ¬æ¦‚å¿µä¸å¤ªæ¸…æ¥šï¼Œå»ºè®®å…ˆè¿‡ä¸€ä¸‹åŸºæœ¬çš„èµ„æºç±»å‹å†é˜…è¯»æ­¤æ–‡*

  å…ˆéšä¾¿ç»™ä¸ªä¾‹å­:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-config
data:
  config.yml: |-
    start-message: 'Hello, World!'
    log-level: INFO
  bootstrap.yml:
    listen-address: '127.0.0.1:8080'
```

  æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª`ConfigMap`ï¼Œdataä¸­å®šä¹‰äº†ä¸¤ä¸ªæ–‡ä»¶`config.yml`ä»¥åŠ`bootstrap.yml`ï¼Œå½“æˆ‘ä»¬è¦å¼•ç”¨å½“ä¸­çš„é…ç½®çš„æ—¶å€™ï¼Œ`kubernetes`æä¾›äº†ä¸¤ç§æ–¹æ¡ˆï¼š

- ä½¿ç”¨`configMapKeyRef`å¼•ç”¨`configMap`ä¸­æŸä¸ªæ–‡ä»¶çš„å†…å®¹ä½œä¸ºPodä¸­å®¹å™¨çš„ç¯å¢ƒå˜é‡ã€‚
- æŠŠæ‰€æœ‰`configMap`ä¸­çš„æ–‡ä»¶å†™åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼Œå°†ä¸´æ—¶ç›®å½•ä½œä¸ºvolumeæŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯`configmap`ç±»å‹çš„`volume`ã€‚

  å‡è®¾ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª`Deployment`ï¼Œå®ƒçš„podæ¨¡æ¿é‡Œå¼•ç”¨äº†`configMap`ï¼Œç°åœ¨æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼š**å½“`configmap`æ›´æ–°çš„æ—¶å€™ï¼Œè¿™ä¸ª`Deployment`çš„ä¸šåŠ¡é€»è¾‘ä¹Ÿèƒ½éšä¹‹æ›´æ–°**ã€‚é‚£ä¹ˆæœ‰å“ªäº›æ–¹æ¡ˆï¼Ÿ

- æœ€å¥½çš„æƒ…å†µæ˜¯ï¼Œå½“`configMap`å‘ç”Ÿå˜æ›´æ—¶ï¼Œç›´æ¥è¿›è¡Œhot updateï¼Œåšåˆ°ä¸å½±å“podçš„æ­£å¸¸è¿è¡Œã€‚
- å¦‚æœæ— æ³•hot updateæˆ–è€…è¿™æ ·å®Œæˆä¸äº†éœ€æ±‚ï¼Œå°±è¦å‡ºå‘å¯¹åº”çš„`Deployment`åšä¸€æ¬¡æ»šåŠ¨æ›´æ–°ã€‚

  

## åœºæ™¯ä¸€ï¼š é’ˆå¯¹å¯ä»¥è¿›è¡Œçƒ­æ›´æ–°çš„å®¹å™¨ï¼Œè¿›è¡Œé…ç½®çƒ­æ›´æ–°

  å¦‚æœ`configMap`ç”±volumeæŒ‚è½½ï¼Œæ¯”å¦‚ä¸‹è¿°çš„æŠ•å°„å·ï¼Œå®ƒçš„å†…å®¹æ˜¯å¯ä»¥æ›´æ–°çš„ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: volume-test
spec:
  containers:
  - name: container-test
    image: busybox
    volumeMounts:
    - name: all-in-one
      mountPath: "/projected-volume"
      readOnly: true
  volumes:
  - name: all-in-one
    projected:
      sources:
      - configMap:
          name: myconfigmap
          items:
            - key: config
              path: my-group/my-config
```

  ä¸ºäº†èƒ½å¤Ÿæ¯”è¾ƒå¥½å¾—ç†è§£ï¼Œå…ˆè¯´æ˜ä¸€ä¸‹`configMap`çš„volumeæŒ‚è½½æœºåˆ¶ï¼š

> æ›´æ–°æ“ä½œç”±kubeletçš„Pod Reconcileè§¦å‘ã€‚æ¯æ¬¡PodåŒæ­¥çš„æ—¶å€™ï¼ˆ10s defaultï¼‰ï¼Œkubeletéƒ½ä¼šæŠŠPodçš„æ‰€æœ‰`configMap`volumeæ ‡è®°ä¸º`RequireRemount`ï¼Œè€Œkubeletä¸­çš„volumeå¾ªç¯æ§åˆ¶ä¼šå‘ç°è¿™äº›éœ€è¦é‡æ–°æŒ‚è½½çš„volumeï¼Œå»æ‰§è¡Œä¸€æ¬¡æŒ‚è½½æ“ä½œã€‚

  åœ¨`configMap`çš„é‡æŒ‚è½½è¿‡ç¨‹ä¸­ï¼Œkubeletä¼šå…ˆæ¯”è¾ƒè¿œç«¯çš„`configMap`å’Œvolumeä¸­çš„`configMap`æ˜¯å¦ä¸€è‡´ï¼Œç„¶åå†åšæ›´æ–°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‹¿åˆ°çš„è¿œç«¯`configMap`æ“ä½œå¯èƒ½æœ‰cacheï¼Œä¸ä¸€å®šæ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚

  æ‰€ä»¥è¿™æ ·çš„æ›´æ–°æ–¹å¼çš„ç¡®å¯è¡Œï¼Œä½†æ˜¯ä¼šæœ‰æ›´æ–°å»¶æ—¶ï¼Œæœ€å¤šçš„å»¶æ—¶æ—¶é—´ï¼š

**PodåŒæ­¥é—´éš”(é»˜è®¤10s) + ConfigMapæœ¬åœ°çš„ç¼“å­˜TTL**

> kubelet ä¸Š ConfigMap çš„è·å–æ˜¯å¦å¸¦ç¼“å­˜ç”±é…ç½®ä¸­çš„`ConfigMapAndSecretChangeDetectionStrategy` å†³å®šã€‚
>
> æ³¨æ„ï¼Œå‡å¦‚ä½¿ç”¨äº† `subPath` å°† ConfigMap ä¸­çš„æŸä¸ªæ–‡ä»¶å•ç‹¬æŒ‚è½½åˆ°å…¶å®ƒç›®å½•ä¸‹ï¼Œé‚£è¿™ä¸ªæ–‡ä»¶æ˜¯æ— æ³•çƒ­æ›´æ–°çš„ï¼ˆè¿™æ˜¯ ConfigMap çš„æŒ‚è½½é€»è¾‘å†³å®šçš„ï¼‰

  çŸ¥é“äº†åŸç†ï¼Œæˆ‘ä»¬å°±æ˜ç¡®ä¸€äº›æ¦‚å¿µï¼š

1. å¦‚æœåº”ç”¨å¯¹`configMap`çš„æ›´æ–°æœ‰å®æ—¶æ€§è¦æ±‚ï¼Œå°±éœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘é‡Œè‡ªå·±åˆ°`ApiServer`å»watchå¯¹åº”çš„`configMap`ï¼Œæˆ–è€…å¹²è„†ä¸ç”¨`configMap`è€Œç”¨`etcd`è¿™æ ·çš„ä¸€è‡´æ€§kvæ¥å­˜å‚¨ç®¡ç†é…ç½®ã€‚
2. åŠ å…¥æ²¡æœ‰å®æ—¶æ€§è¦æ±‚ï¼Œé‚£ä¹ˆ`configMap`æœ¬èº«çš„æ›´æ–°é€»è¾‘å°±å¯ä»¥åšåˆ°ã€‚

  ä¸è¿‡é…ç½®æ–‡ä»¶æ›´æ–°å®Œäº†å°±ä¸ä»£è¡¨ä¸šåŠ¡é€»è¾‘å°±æ›´æ–°äº†ï¼Œæˆ‘ä»¬è¿˜è¦è§£å†³å¦‚ä½•é€šçŸ¥åº”ç”¨é‡æ–°è¯»å–é…ç½®ï¼Œè¿›è¡Œä¸šåŠ¡é€»è¾‘ä¸Šçš„æ›´æ–°ã€‚ä¾‹å¦‚å¯¹äº`nginx`å°±éœ€è¦ä¸€ä¸ª`SIGHUP`ä¿¡å·é‡ï¼Œè¿™é‡Œå†è®¨è®ºå‡ ç§åšæ³•ã€‚

### çƒ­æ›´æ–°ä¸€ï¼š åº”ç”¨æœ¬èº«ç›‘å¬æœ¬åœ°é…ç½®æ–‡ä»¶

  è¿™æ˜¯æœ€ç›´æ¥çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨åº”ç”¨é‡Œå†™ç›‘å¬çš„ä»£ç ã€‚ä¸€äº›é…ç½®ç›¸å…³çš„ä¸‰æ–¹ä»¶æœ¬èº«å°±åŒ…è£…äº†è¿™æ ·çš„é€»è¾‘ï¼Œæ¯”å¦‚[viper](https://github.com/spf13/viper)



### çƒ­æ›´æ–°äºŒï¼šä½¿ç”¨sidecarç›‘å¬æœ¬åœ°æ–‡ä»¶çš„å˜æ›´

  `Prometheus`çš„`Helm Chart`ä¸­ä½¿ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼ï¼Œæ‰¾åˆ°ä¸€ä¸ªå®ç”¨çš„é•œåƒ[configmap-reload](https://github.com/jimmidyson/configmap-reload)ï¼Œå®ƒå°±ä¼šå»watchæœ¬åœ°æ–‡ä»¶çš„å˜æ›´ï¼Œå¹¶åœ¨å‘ç”Ÿå˜æ›´æ—¶é€šè¿‡HTTPè°ƒç”¨é€šçŸ¥åº”ç”¨è¿›è¡Œçƒ­æ›´æ–°ã€‚

  è¿™ç§æ–¹å¼å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼šsidecarå‘é€ä¿¡å·çš„é™åˆ¶æ¯”è¾ƒå¤šï¼Œè€Œå¾ˆå¤šå¼€æºç»„ä»¶æ¯”å¦‚`Fluentd`ï¼Œ`nginx`éƒ½æ˜¯ä¾èµ–`SIGHUP`ä¿¡å·è¿›è¡Œçƒ­æ›´æ–°çš„ã€‚åœ¨`kubernetes` 1.10ä¹‹å‰ï¼Œå¹¶ä¸æ”¯æŒpodä¸­çš„å®¹å™¨å…±äº«åŒä¸€ä¸ªpid namespaceï¼Œæ‰€ä»¥sidecarä¹Ÿå°±æ— æ³•å‘ä¸šåŠ¡å®¹å™¨å‘é€ä¿¡å·ã€‚åœ¨1.10ä»¥åï¼Œè™½ç„¶æ”¯æŒäº†pidå…±äº«ï¼Œä½†æ˜¯åœ¨å…±äº«ä¹‹åpid namespaceä¸­çš„1å·è¿›ç¨‹å°±ä¼šå˜æˆåŸºç¡€çš„`/pause`è¿›ç¨‹ï¼Œæˆ‘ä»¬ä¾¿æ— æ³•è½»æ¾å®šä½åˆ°ç›®æ ‡è¿›ç¨‹äº†ã€‚

  æ‰€ä»¥ï¼Œåªè¦k8sç‰ˆæœ¬åœ¨1.10ä»¥åï¼Œå¹¶ä¸”å¼€å¯äº†`ShareProcessNamespace`ç‰¹æ€§ï¼Œå¤šå†™ç‚¹ä»£ç ï¼Œæ¯”å¦‚é€šè¿‡è¿›ç¨‹åå»æ‰¾åˆ°pidï¼Œæ€»æ˜¯æœ‰åŠæ³•çš„ã€‚ä½†æ˜¯1.10ä¹‹å‰æ˜¯æ²¡å¯èƒ½çš„ã€‚



### çƒ­æ›´æ–°ä¸‰ï¼šFat Container

  èƒ–å®¹å™¨æ¯”è¾ƒ`åæ¨¡å¼`ï¼Œä¸è¿‡å¯ä»¥è§£å†³sidecarçš„ä¸€äº›é™åˆ¶ï¼ŒæŠŠä¸»è¿›ç¨‹å’Œsidecarè¿›ç¨‹æ‰“è¿›ä¸€ä¸ªé•œåƒé‡Œï¼Œè¿™æ ·å°±ç»•è¿‡äº†pid namespaceéš”ç¦»çš„é—®é¢˜ã€‚ä½†æ˜¯å¦‚æœæ¡ä»¶å…è®¸ï¼Œè¿˜æ˜¯ç”¨ä¸Šè¿°ä¸¤ä¸ªæ–¹æ¡ˆï¼Œå› ä¸ºå¤æ‚æ˜¯è„†å¼±çš„æ ¹æºï¼Œå®¹å™¨æœ¬èº«æ˜¯è½»é‡çš„ã€‚



## åœºæ™¯äºŒï¼š æ— æ³•çƒ­æ›´æ–°æ—¶ï¼Œæ»šåŠ¨æ›´æ–°Pod

æ— æ³•çƒ­æ›´æ–°çš„åœºæ™¯ä¸¾ä¾‹æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

1. åº”ç”¨æœ¬èº«æ²¡å†™çƒ­æ›´æ–°é€»è¾‘ï¼ˆå¤§éƒ¨åˆ†åº”ç”¨ä¸ä¼šå†™ï¼‰ã€‚
2. ä½¿ç”¨`subPath`è¿›ç¨‹`configMap`çš„æŒ‚è½½ï¼Œå¯¼è‡´`configMap`æ— æ³•è‡ªåŠ¨æ›´æ–°ã€‚
3. åœ¨ç¯å¢ƒå˜é‡æˆ–è€…`init-container`ä¸­ä¾èµ–äº†`configMap`çš„å†…å®¹ã€‚

  ç¬¬ä¸‰ç‚¹ï¼Œå°±æ˜¯ä½¿ç”¨`configMapKeyRef`å¼•ç”¨`configMap`ä¸­çš„ä¿¡æ¯ä½œä¸ºç¯å¢ƒå˜é‡æ—¶ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿåªä¼šåœ¨podåˆ›å»ºæ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥æ˜¯ä¸ä¼šè‡ªåŠ¨æ›´æ–°çš„ã€‚

  å½“æ— æ³•è¿›è¡Œçƒ­æ›´æ–°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»æ»šåŠ¨å»æ›´æ–°Podäº†ã€‚ä¸€ä¸ªç®€å•çš„æƒ³æ³•å°±æ˜¯å†™ä¸ªcontrollerå»watch`configMap`çš„å˜æ›´ï¼Œæœ‰å˜æ›´å°±ç»™`Deployment`èµ„æºåšæ»šåŠ¨æ›´æ–°ã€‚ä½†æ˜¯è¿™æ ·çš„å®ç°æ˜¯æ›´å¤æ‚çš„ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è€ƒè™‘æœ‰æ²¡æœ‰æ›´ç®€å•çš„æ–¹å¼ã€‚



### æ»šåŠ¨æ›´æ–°ä¸€ï¼š ä¿®æ”¹CIæµç¨‹

  è¿™ä¸ªæ–¹å¼å¾ˆç®€å•ï¼Œåªéœ€è¦å†™ä¸€ä¸ªCIè„šæœ¬ï¼Œç»™`ConfigMap`è®¡ç®—ä¸€ä¸ªhashï¼Œç„¶åä½œä¸ºä¸€ä¸ªç¯å¢ƒå˜é‡æˆ–è€…annotationåŠ å…¥åˆ°Deploymentçš„Podæ¨¡æ¿ä¸­ã€‚

  ä¸¾ä¸ªğŸŒ°:

```yaml
...
spec:
  template:
    metadata:
      annotations:
        com.cctoctofx.configmap/hash: ${CONFIGMAP_HASH}
...
```

  è¿™æ ·ï¼Œå¦‚æœ`configMap`å˜åŒ–äº†ï¼Œé‚£ä¹ˆDeploymenté‡Œçš„Podæ¨¡æ¿è‡ªç„¶ä¼šå˜åŒ–ï¼Œk8sä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åšæ»šåŠ¨æ›´æ–°ã€‚ç”šè‡³å¦‚æœ`configMap`ä¸å¤æ‚ï¼Œç›´æ¥è½¬åŒ–ä¸ºjsonæ”¾åˆ°podæ¨¡æ¿é‡Œéƒ½è¡Œï¼Œè€Œä¸”è¿˜æ–¹ä¾¿æ•…éšœæ’æŸ¥çš„æ—¶å€™å¿«é€ŸçŸ¥é“å†…å®¹æ˜¯å•¥ã€‚



### æ»šåŠ¨æ›´æ–°äºŒï¼šController

  å†™ä¸ªcontrolleræ£€æµ‹`configMap`å˜æ›´å¹¶è§¦å‘æ»šåŠ¨æ›´æ–°ï¼Œæ‰‹åŠ¨å†™ä¹‹å‰è¿˜æ˜¯çœ‹ä¸€çœ‹å¼€æºå®ç°ï¼š

- [Reloader](https://github.com/stakater/Reloader)
- [ConfigmapController](https://github.com/fabric8io/configmapcontroller)
- [k8s-trigger-controller](https://github.com/mfojtik/k8s-trigger-controller)

  

### æ»šåŠ¨æ›´æ–°ä¸‰ï¼šLiveness Probe / Readiness Probe

  è¿™ä¸ªæ‰‹æ®µéœ€è¦æ·±å…¥ä¸€ä¸‹ï¼Œåˆæ­¥æƒ³æ³•æ˜¯ç”¨livenessè°ƒç”¨ä¸€ä¸ªè„šæœ¬ï¼Œè„šæœ¬åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å˜åŠ¨ï¼Œå¦‚æœå˜åŠ¨ï¼Œlivenesså¾—åˆ°falseï¼Œé‡å¯podï¼Œä¹Ÿå¯ä»¥åŒæ—¶è®¾ç½®readinessã€‚



## æ»šåŠ¨æ›´æ–°éœ€è¦è€ƒè™‘çš„é—®é¢˜

  ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ç”¨åœºæ™¯äºŒä¸­æåˆ°çš„æ–¹å¼å»æ›´æ–°ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  template:
    annotations:
      nginx-config-md5: d41d8cd98f00b204e9800998ecf8427e
    spec:
      containers:
      - name: nginx
        image: nginx
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/config
      volumes:
      - name: config-volume
        configMap: 
          name: nginx-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |-
    ## some configurations...
```

>- æ¯æ¬¡éƒ¨ç½²çš„æ—¶å€™ï¼Œè®¡ç®—configMapçš„MD5,å¡«å…¥podçš„templateä¸­.
>- åŠ å…¥configMapå‘ç”Ÿå˜åŒ–ï¼Œæ‘˜è¦ä¹Ÿä¼šå˜åŒ–ï¼Œä¼šè§¦å‘ä¸€æ¬¡Deploymentçš„æ»šåŠ¨æ›´æ–°ã€‚

  è¿™ä¸ªæµç¨‹çœ‹èµ·æ¥æ¯”è¾ƒç¾ï¼Œä½†æ€è€ƒä¸€ä¸‹å¦‚æœæˆ‘ä»¬æ›´æ–°äº†ä¸€ä¸ªé…ç½®ï¼Œä½†è¿™ä¸ªé…ç½®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¦‚æœpodä½¿ç”¨äº†é”™è¯¯çš„é…ç½®ä¼šæ— æ³•å·¥ä½œï¼ˆæ¯”å¦‚æ— æ³•é€šè¿‡`readinessProb`æ£€æŸ¥ï¼‰ã€‚æœ€åï¼Œæ»šåŠ¨æ›´æ–°çš„æµç¨‹å°±ä¼šå¡ä½ï¼Œé”™è¯¯çš„é…ç½®ä¸ä¼šæŠŠDeploymentæå´©æ‰ã€‚

  è¿™ä¸ªé€»è¾‘çœ‹ç€ä¹ŸæŒºå¥½ï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜å´å¿½è§†äº†ï¼Œå¦‚æœ`nginx-config`æ›´æ–°æˆäº†é”™è¯¯çš„å€¼ï¼Œè™½ç„¶**è¿˜æ²¡æœ‰é‡å»ºçš„Pod**æš‚æ—¶æ˜¯å¥åº·çš„ï¼Œä½†æ˜¯å¦‚æœPodæŒ‚æ‰å‘ç”Ÿé‡å»ºï¼Œæˆ–è€…å…¶ä¸­çš„å®¹å™¨é‡æ–°è¯»å–äº†ä¸€æ¬¡é…ç½®ï¼Œé‚£ä¹ˆè¿™äº›Podå°±ä¼šé™·å…¥å¼‚å¸¸ã€‚æ‰€ä»¥æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€æ˜¯å¾ˆä¸ç¨³å®šçš„ã€‚

  å› æ­¤é—®é¢˜çš„æœ¬è´¨æ˜¯ï¼š**åœ¨åŸåœ°æ›´æ–°`configMap`æˆ–è€…`secret`çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è¿›è¡Œæ»šåŠ¨å‘å¸ƒï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§æŠŠæ–°çš„é…ç½®æ›´æ–°åˆ°æ•´ä¸ªé›†ç¾¤çš„æ‰€æœ‰å®ä¾‹å½“ä¸­**ã€‚è€Œæˆ‘ä»¬æ‰€è¯´çš„`æ»šåŠ¨æ›´æ–°`å°±æ˜¯æ§åˆ¶å„ä¸ªå®ä¾‹è¯»å–æ–°çš„é…ç½®çš„æ—¶æœºï¼Œå¯æ˜¯ç”±äºæˆ‘ä»¬æ— æ³•æŠŠæ§PodæŒ‚æ‰çš„æ—¶æœºï¼Œæˆ‘ä»¬æ— æ³•å‡†ç¡®è¿›è¡Œè¿‡ç¨‹æ§åˆ¶ã€‚

  ### è§£å†³æ–¹æ¡ˆ

  ä¸Šè¿°é—®é¢˜çš„é—®é¢˜åœ¨äº**åŸåœ°æ›´æ–°**ï¼Œè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåªéœ€è¦åœ¨æ¯æ¬¡`ConfigMap`å˜åŒ–çš„æ—¶å€™ï¼Œé‡æ–°ç”Ÿæˆä¸€ä¸ª`ConfigMap`ï¼Œå†æ›´æ–°Deploymentä½¿ç”¨è¿™ä¸ªæ–°çš„`ConfigMap`å°±è¡Œäº†ã€‚è€Œé‡æ–°ç”Ÿæˆ`ConfigMap`æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åœ¨å…¶å‘½åä¸­åŠ ä¸Š`ConfigMap`çš„dataå€¼è®¡ç®—å‡ºçš„æ‘˜è¦ï¼Œæ¯”å¦‚ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config-d41d8cd98f00b204e9800998ecf8427e
data:
  nginx.conf: |-
    ## some configurations...
```

  `ConfigMap`çš„Rolloutåœ¨ç¤¾åŒºä¸­ä¹Ÿæ˜¯å†ç»å¾ˆä¹…è¿˜æ²¡æœ‰è§£å†³([#22368](https://zhuanlan.zhihu.com/p/66051135/22368))ï¼Œç›®å‰ä¸ºæ­¢ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹å‘ä¹Ÿæ˜¯`immutable configmap`æ¨¡å¼ã€‚

  ä½†æ˜¯è¿™ç§æ–¹æ¡ˆä¼šæœ‰å‡ ä¸ªé—®é¢˜ï¼š

> - å¦‚ä½•åšåˆ°æ¯æ¬¡é…ç½®æ–‡ä»¶æ›´æ–°æ—¶ï¼Œéƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„ConfigMapï¼Ÿ
> - ç›®å‰ç¤¾åŒºçš„æ€åº¦æ˜¯æŠŠè¿™ä¸€æ­¥æ”¾åˆ°Clientè§£å†³ï¼Œæ¯”å¦‚helmå’Œkustomizeã€‚
> - å†å²configMapä¸æ–­ç§¯ç´¯ï¼Œèƒ½æ€ä¹ˆå›æ”¶ï¼Ÿ
> - é’ˆå¯¹è¿™ç‚¹ï¼Œç¤¾åŒºå¸Œæœ›åœ¨æœåŠ¡ç«¯å®ç°ä¸€ä¸ªGCæœºåˆ¶æ¥æ¸…ç†æ²¡æœ‰ä»»ä½•èµ„æºå¼•ç”¨çš„configMapã€‚

  æŠŠæ›´æ–°é€»è¾‘æ”¾åœ¨clientç«¯è™½ç„¶ä¼šæœ‰é‡å¤é€ è½®å­çš„é—®é¢˜ï¼Œä½†æ˜¯è‡³å°‘ç›®å‰ä¸ºæ­¢ï¼ŒconfigMapçš„æ–°å»ºå’ŒDeploymentç­‰å¯¹è±¡çš„æ›´æ–°æ˜¯æœ€æˆç†Ÿçš„configMapæ»šåŠ¨æ›´æ–°æ–¹æ¡ˆã€‚

  ### Kustomizeçš„å®è·µæ–¹å¼

  Kustomizeå¯¹è¿™ä¸ªæ–¹æ¡ˆæœ‰å†…ç½®çš„æ”¯æŒï¼Œåªéœ€è¦ä½¿ç”¨`configGenerator`ï¼š

```yaml
configMapGenerator:
- name: my-configmap
  files:
  - common.properties
```

  è¿™æ®µyamlå°±èƒ½åœ¨kustomizeä¸­ç”Ÿæˆä¸€ä¸ªconfigMapå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡çš„dataæ¥è‡ªäº`common.properties`æ–‡ä»¶ï¼Œè€Œä¸”nameä¸­ä¼šåŠ ä¸Šè¿™ä¸ªæ–‡ä»¶çš„SHAå€¼ä½œä¸ºåç¼€ã€‚

  åœ¨kustomizeçš„å…¶ä»–layerä¸­ï¼Œåªè¦ä»¥`my-configmap`ä½œä¸ºnameå¼•ç”¨è¿™ä¸ªconfigMapå³å¯ï¼Œå½“æœ€ç»ˆæ¸²æŸ“çš„æ—¶å€™ï¼Œkustomizeä¼šè‡ªåŠ¨è¿›è¡Œæ›¿æ¢æ“ä½œã€‚

 

### Helmçš„å®è·µæ–¹å¼

...



## é™„å½•

[facilitate ConfigMap rollouts/management discussion](https://github.com/kubernetes/kubernetes/issues/22368#issuecomment-421141188)

